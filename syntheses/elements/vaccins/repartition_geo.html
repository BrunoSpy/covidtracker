<h2 id="cartes_vaccins" class="navbar-anchor">
    Répartition géographique des vaccinés
</h2>

<br>
<div class="row">
    <div class="col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Par départements</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6" id="blocCarteDepartement">

                    </div>
                    <div class="col-md-6" id="detailDepartement">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Par régions</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6" id="blocCarteRegion">

                    </div>
                    <div class="col-md-6" id="detailRegion">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Première dose en EHPAD par départements</div>
            <div class="card-body" id="blocCarteEHPADDepartement1"></div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Deuxième dose en EHPAD par départements</div>
            <div class="card-body" id="blocCarteEHPADDepartement2"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        let tableauValeursDepartements = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        let tableauCouleursDepartements= [
            "#cfdde6",
            "#b8d4e6",
            "#a1cbe6",
            "#8ac2e6",
            "#73bae6",
            "#5cb1e6",
            "#45a8e6",
            "#2e9fe6",
            "#1796e6",
            "#0076bf"
        ];

        let departements = {{ site.data.departements | jsonify}};
        let data = {{ site.data.json.vaccins.vacsi-dep | jsonify }};
        delete data.departements; //remove first entry
        //add dep num in value
        for (var key in data) {
            data[key].num_dep = key;
            let depEntry =  Object.values(departements).filter(function(dep){
                return dep.num_dep == key;
            });
            if(depEntry.length > 0) {
                data[key].name = depEntry[0].dep_name;
            }
        }
        console.log(data);
        $('#blocCarteDepartement').datamap({
            svgPath: "{{ '/assets/svg/departements.svg' | prepend: site.baseurl }}",
            data: data,
            svgId: 'data-num',
            values: tableauValeursDepartements,
            colors: tableauCouleursDepartements,
            valueKey: 'n_dose1_cumsum_pop',
            legendDirection: "ascending",
            iterationKey: 'num_dep'
        });

        let valeursRegions = tableauValeursDepartements;
        let couleursRegions = tableauCouleursDepartements;
        let datareg = {{ site.data.json.vaccins.vacsi-reg | jsonify }};
        let populationRegion = {{ site.data.regions | jsonify }};

        let datatemp = Object.entries(datareg);

        let newdata = [];

        //transform data to more suitable format
        populationRegion.forEach(region => {
            let dataregion = datatemp.filter(function(obj) {
                return obj[1].code == region.region;
            });
            let dataregionLastDate = dataregion.reduce(function(prev, current){
                return (prev[1].date > current[1].date) ? prev : current;
            })[1];

            let code = dataregionLastDate.code.replace('REG-', '');
            let data = {
                code: code,
                region: dataregionLastDate.nom,
                n_dose1_cumsum: dataregionLastDate.n_dose1_cumsum,
                n_dose1_cumsum_moyenne7j: dataregionLastDate.n_dose1_cumsum_moyenne7j,
                date: dataregionLastDate.date
            };
            data.population = region.population;
            data.couvertureVaccinale = data.n_dose1_cumsum / data.population * 100;
            newdata.push(data);
        });

        $('#blocCarteRegion').datamap({
            svgPath: "{{ '/assets/svg/regions.svg' | prepend: site.baseurl }}",
            data: newdata,
            svgId: 'data-code_insee',
            values: valeursRegions,
            colors: couleursRegions,
            valueKey: 'couvertureVaccinale',
            legendDirection: "ascending",
            iterationKey: 'code'
        });

        let tableauValeursEHPAD = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90]

        let tableauCouleursEHPAD1dose= [
            "#cfdde6",
            "#b8d4e6",
            "#a1cbe6",
            "#8ac2e6",
            "#73bae6",
            "#5cb1e6",
            "#45a8e6",
            "#2e9fe6",
            "#1796e6",
            "#0076bf"
        ];
        let tableauCouleursEHPAD2doses= [
            "#9cb394",
            "#90b384",
            "#80ae73",
            "#71ab60",
            "#65a950",
            "#56ab3d",
            "#2e9c28",
            "#1c7b21",
            "#116522",
            "#084004"
        ];
        //ehpad departements
        let dataEHPAD = {{ site.data.json.vaccins.vacsi-res-tot-dep | jsonify }};
        let dataEHPAD_ = [];
        for(const key in dataEHPAD) {
            let entry = {
                num_dep: key,
                res_couv_tot_dose1: dataEHPAD[key].res_couv_tot_dose1,
                res_couv_tot_dose2: dataEHPAD[key].res_couv_tot_dose2
            }
            let depEntry =  Object.values(departements).filter(function(dep){
                return dep.num_dep == key;
            });
            if(depEntry.length > 0) {
                entry.name = depEntry[0].dep_name;
            }
            dataEHPAD_.push(entry);
        }

        $("#blocCarteEHPADDepartement1").datamap({
            svgPath: "{{ '/assets/svg/departements.svg' | prepend: site.baseurl }}",
            data: dataEHPAD_,
            values: tableauValeursEHPAD,
            colors: tableauCouleursEHPAD1dose,
            legendDirection: "ascending",
            iterationKey: "num_dep",
            valueKey: "res_couv_tot_dose1"
        });
        $("#blocCarteEHPADDepartement2").datamap({
            svgPath: "{{ '/assets/svg/departements.svg' | prepend: site.baseurl }}",
            data: dataEHPAD_,
            values: tableauValeursEHPAD,
            colors: tableauCouleursEHPAD2doses,
            legendDirection: "ascending",
            iterationKey: "num_dep",
            valueKey: "res_couv_tot_dose2"
        });
    });
</script>
