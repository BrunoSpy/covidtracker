<h2 id="cartes_vaccins" class="navbar-anchor">
    Répartition géographique des vaccinés
</h2>

<div class="">
    Coloration en fonction du pourcentage de population vaccinée.
    Données fournies par le Ministère de la Santé.
    Cliquez sur une région pour afficher plus de détails.
</div>
<br>
<div class="row">
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Par départements</div>
            <div class="card-body" id="blocCarteDepartement"></div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Par régions</div>
            <div class="card-body" id="blocCarteRegion"></div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Vaccinations en EHPAD par départements</div>
            <div class="card-body" id="blocCarteEHPADDepartement"></div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12 mt-3">
        <div class="card zoomable">
            <div class="card-header">Vaccinations en EHPAD par régions</div>
            <div class="card-body" id="blocCarteEHPADRegions"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        let tableauValeursDepartements = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        let tableauCouleursDepartements= [
            "#cfdde6",
            "#b8d4e6",
            "#a1cbe6",
            "#8ac2e6",
            "#73bae6",
            "#5cb1e6",
            "#45a8e6",
            "#2e9fe6",
            "#1796e6",
            "#0076bf"
        ];

        let data = {{ site.data.json.vaccins.vacsi-dep | jsonify }};
        delete data.departements; //remove first entry
        //add dep num in value
        for (var key in data) {
            data[key].num_dep = key;
        }
        $('#blocCarteDepartement').datamap({
            svgPath: "{{ '/assets/svg/departements.svg' | prepend: site.baseurl }}",
            data: data,
            svgId: 'data-num',
            values: tableauValeursDepartements,
            colors: tableauCouleursDepartements,
            valueKey: 'n_dose1_cumsum_pop',
            legendDirection: "ascending",
            iterationKey: 'num_dep'
        });

        let valeursRegions = tableauValeursDepartements;
        let couleursRegions = tableauCouleursDepartements;
        let datareg = {{ site.data.json.vaccins.vacsi-reg | jsonify }};
        let populationRegion = {{ site.data.regions | jsonify }};

        let datatemp = Object.entries(datareg);

        let newdata = [];

        //transform data to more suitable format
        populationRegion.forEach(region => {
            let dataregion = datatemp.filter(function(obj) {
                return obj[1].code == region.region;
            });
            let dataregionLastDate = dataregion.reduce(function(prev, current){
                return (prev[1].date > current[1].date) ? prev : current;
            })[1];

            let code = dataregionLastDate.code.replace('REG-', '');
            let data = {
                code: code,
                region: dataregionLastDate.nom,
                n_dose1_cumsum: dataregionLastDate.n_dose1_cumsum,
                n_dose1_cumsum_moyenne7j: dataregionLastDate.n_dose1_cumsum_moyenne7j,
                date: dataregionLastDate.date
            };
            data.population = region.population;
            data.couvertureVaccinale = data.n_dose1_cumsum / data.population * 100;
            newdata.push(data);
        });

        $('#blocCarteRegion').datamap({
            svgPath: "{{ '/assets/svg/regions.svg' | prepend: site.baseurl }}",
            data: newdata,
            svgId: 'data-code_insee',
            values: valeursRegions,
            colors: couleursRegions,
            valueKey: 'couvertureVaccinale',
            legendDirection: "ascending",
            iterationKey: 'code'
        });

        var tableauValeursEHPAD = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90]

        var tableauCouleursEHPAD1dose= [
            "#cfdde6",
            "#b8d4e6",
            "#a1cbe6",
            "#8ac2e6",
            "#73bae6",
            "#5cb1e6",
            "#45a8e6",
            "#2e9fe6",
            "#1796e6",
            "#0076bf"
        ];

        //ehpad departements
        let dataEHPAD = {{ site.data.json.vaccins.vacsi-res-tot-dep | jsonify }};
        $("#blocCarteEHPADDepartement").datamap({
            svgPath: "{{ '/assets/svg/departements.svg' | prepend: site.baseurl }}",
            data: dataEHPAD,
            values: tableauValeursEHPAD,
            colors: tableauCouleursEHPAD1dose,
            legendDirection: "ascending"
        });
    });
</script>
